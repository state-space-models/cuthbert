
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://state-space-models.github.io/cuthbert/examples/online_stoch_vol/">
      
      
        <link rel="prev" href="../temporal_parallelization_kalman/">
      
      
        <link rel="next" href="../parameter_estimation_em/">
      
      
        
      
      
      <link rel="icon" href="../../assets/cuthbert_c.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>Online Filtering and Prediction - cuthbert</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#online-filtering-and-prediction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="cuthbert" class="md-header__button md-logo" aria-label="cuthbert" data-md-component="logo">
      
  <img src="../../assets/cuthbert.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            cuthbert
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Online Filtering and Prediction
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="green"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/state-space-models/cuthbert" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="cuthbert" class="md-nav__button md-logo" aria-label="cuthbert" data-md-component="logo">
      
  <img src="../../assets/cuthbert.png" alt="logo">

    </a>
    cuthbert
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/state-space-models/cuthbert" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kalman_tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kalman Tracking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../temporal_parallelization_kalman/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Temporally-Parallelized Kalman Filter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Online Filtering and Prediction
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Online Filtering and Prediction
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup-and-imports" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup and imports
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Load data
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-inputs-for-cuthbert" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model inputs for cuthbert
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stochastic-volatility-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Stochastic volatility model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-the-particle-filter" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup the particle filter
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#online-prediction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Online prediction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#online-filtering" class="md-nav__link">
    <span class="md-ellipsis">
      
        Online filtering
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Takeaways
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../parameter_estimation_em/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parameter Estimation with Expectation Maximization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dynamax_integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamax Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../cuthbert_api/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    cuthbert API
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    cuthbert API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/filtering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Filtering
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/smoothing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Smoothing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/discrete/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Discrete HMMs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../cuthbert_api/gaussian/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gaussian filters and smoothers
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gaussian filters and smoothers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/gaussian/kalman/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exact Kalman
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/gaussian/moments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Moments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/gaussian/taylor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Taylor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../cuthbert_api/smc/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Sequential Monte Carlo
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Sequential Monte Carlo
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/smc/backward_sampler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Backward Sampler
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/smc/marginal_particle_filter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Marginal Particle Filter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/smc/particle_filter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Particle Filter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbert_api/smc/types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../cuthbertlib_api/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    cuthbertlib API
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    cuthbertlib API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/discrete/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Discrete HMMs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/kalman/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kalman
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/linalg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linalg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/linearize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linearize
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/quadrature/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quadrature Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/resampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Resampling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/smc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SMC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stats
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cuthbertlib_api/types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup-and-imports" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup and imports
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Load data
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-inputs-for-cuthbert" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model inputs for cuthbert
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stochastic-volatility-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Stochastic volatility model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-the-particle-filter" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup the particle filter
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#online-prediction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Online prediction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#online-filtering" class="md-nav__link">
    <span class="md-ellipsis">
      
        Online filtering
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Takeaways
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="online-filtering-and-prediction">Online Filtering and Prediction</h1>
<p>A key feature of inference in state-space models is that estimates can be updated
online as new data arrives. In this example, we'll use <code>cuthbert</code> to infer the
volatility of the Marks &amp; Spencer stock price data and then use it to predict
a future volatility and stock price before updating the approximation with new data.</p>
<p>The model we'll use is a simple stochastic volatility model adapted from section 2.4.3
in <a href="https://doi.org/10.1007/978-3-030-47845-2">Chopin and Papaspiliopoulos (2023)</a>.</p>
<p>Of additional interest, we'll define the state-space model dynamics in continuous-time
so that we easily handle the irregular observation times (which occur here as stock
prices aren't available on weekends). We'll also define the observation model in a
convenient way to handle missing data and predict future values using the same
filtering framework.</p>
<h2 id="setup-and-imports">Setup and imports</h2>
<div id="online-stoch-vol-setup" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-setup-1"><a id="__codelineno-online-stoch-vol-setup-1" name="__codelineno-online-stoch-vol-setup-1" href="#__codelineno-online-stoch-vol-setup-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>
</span><span id="__span-online-stoch-vol-setup-2"><a id="__codelineno-online-stoch-vol-setup-2" name="__codelineno-online-stoch-vol-setup-2" href="#__codelineno-online-stoch-vol-setup-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-online-stoch-vol-setup-3"><a id="__codelineno-online-stoch-vol-setup-3" name="__codelineno-online-stoch-vol-setup-3" href="#__codelineno-online-stoch-vol-setup-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-online-stoch-vol-setup-4"><a id="__codelineno-online-stoch-vol-setup-4" name="__codelineno-online-stoch-vol-setup-4" href="#__codelineno-online-stoch-vol-setup-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">Array</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">jnp</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">nn</span>
</span><span id="__span-online-stoch-vol-setup-5"><a id="__codelineno-online-stoch-vol-setup-5" name="__codelineno-online-stoch-vol-setup-5" href="#__codelineno-online-stoch-vol-setup-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">jax.scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
</span><span id="__span-online-stoch-vol-setup-6"><a id="__codelineno-online-stoch-vol-setup-6" name="__codelineno-online-stoch-vol-setup-6" href="#__codelineno-online-stoch-vol-setup-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-online-stoch-vol-setup-7"><a id="__codelineno-online-stoch-vol-setup-7" name="__codelineno-online-stoch-vol-setup-7" href="#__codelineno-online-stoch-vol-setup-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">yfinance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">yf</span>
</span><span id="__span-online-stoch-vol-setup-8"><a id="__codelineno-online-stoch-vol-setup-8" name="__codelineno-online-stoch-vol-setup-8" href="#__codelineno-online-stoch-vol-setup-8"></a>
</span><span id="__span-online-stoch-vol-setup-9"><a id="__codelineno-online-stoch-vol-setup-9" name="__codelineno-online-stoch-vol-setup-9" href="#__codelineno-online-stoch-vol-setup-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cuthbert</span><span class="w"> </span><span class="kn">import</span> <span class="nb">filter</span>
</span><span id="__span-online-stoch-vol-setup-10"><a id="__codelineno-online-stoch-vol-setup-10" name="__codelineno-online-stoch-vol-setup-10" href="#__codelineno-online-stoch-vol-setup-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cuthbert.smc</span><span class="w"> </span><span class="kn">import</span> <span class="n">particle_filter</span>
</span><span id="__span-online-stoch-vol-setup-11"><a id="__codelineno-online-stoch-vol-setup-11" name="__codelineno-online-stoch-vol-setup-11" href="#__codelineno-online-stoch-vol-setup-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cuthbertlib.resampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">adaptive</span><span class="p">,</span> <span class="n">systematic</span>
</span></code></pre></div>
<p>We'll use a simple bootstrap particle filter for inference since our model is
non-linear, non-Gaussian and low-dimensional (so we don't need to worry about the
particle filter curse of dimensionality).</p>
<h2 id="load-data">Load data</h2>
<p>We can use the <a href="https://github.com/ranaroussi/yfinance"><code>yfinance</code></a> library to easily
download the Marks &amp; Spencer stock price data for the past 3 years.</p>
<details class="quote">
<summary>Code to download Marks &amp; Spencer stock price data</summary>
<div id="online-stoch-vol-load-data-func" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-load-data-func-1"><a id="__codelineno-online-stoch-vol-load-data-func-1" name="__codelineno-online-stoch-vol-load-data-func-1" href="#__codelineno-online-stoch-vol-load-data-func-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">download_stock_data</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-load-data-func-2"><a id="__codelineno-online-stoch-vol-load-data-func-2" name="__codelineno-online-stoch-vol-load-data-func-2" href="#__codelineno-online-stoch-vol-load-data-func-2"></a>    <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-online-stoch-vol-load-data-func-3"><a id="__codelineno-online-stoch-vol-load-data-func-3" name="__codelineno-online-stoch-vol-load-data-func-3" href="#__codelineno-online-stoch-vol-load-data-func-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="__span-online-stoch-vol-load-data-func-4"><a id="__codelineno-online-stoch-vol-load-data-func-4" name="__codelineno-online-stoch-vol-load-data-func-4" href="#__codelineno-online-stoch-vol-load-data-func-4"></a>    <span class="k">if</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-online-stoch-vol-load-data-func-5"><a id="__codelineno-online-stoch-vol-load-data-func-5" name="__codelineno-online-stoch-vol-load-data-func-5" href="#__codelineno-online-stoch-vol-load-data-func-5"></a>        <span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-load-data-func-6"><a id="__codelineno-online-stoch-vol-load-data-func-6" name="__codelineno-online-stoch-vol-load-data-func-6" href="#__codelineno-online-stoch-vol-load-data-func-6"></a>
</span><span id="__span-online-stoch-vol-load-data-func-7"><a id="__codelineno-online-stoch-vol-load-data-func-7" name="__codelineno-online-stoch-vol-load-data-func-7" href="#__codelineno-online-stoch-vol-load-data-func-7"></a>    <span class="k">if</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-online-stoch-vol-load-data-func-8"><a id="__codelineno-online-stoch-vol-load-data-func-8" name="__codelineno-online-stoch-vol-load-data-func-8" href="#__codelineno-online-stoch-vol-load-data-func-8"></a>        <span class="c1"># end_date - 3 years</span>
</span><span id="__span-online-stoch-vol-load-data-func-9"><a id="__codelineno-online-stoch-vol-load-data-func-9" name="__codelineno-online-stoch-vol-load-data-func-9" href="#__codelineno-online-stoch-vol-load-data-func-9"></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))[:</span><span class="mi">10</span><span class="p">]</span>
</span><span id="__span-online-stoch-vol-load-data-func-10"><a id="__codelineno-online-stoch-vol-load-data-func-10" name="__codelineno-online-stoch-vol-load-data-func-10" href="#__codelineno-online-stoch-vol-load-data-func-10"></a>
</span><span id="__span-online-stoch-vol-load-data-func-11"><a id="__codelineno-online-stoch-vol-load-data-func-11" name="__codelineno-online-stoch-vol-load-data-func-11" href="#__codelineno-online-stoch-vol-load-data-func-11"></a>    <span class="n">stock</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-load-data-func-12"><a id="__codelineno-online-stoch-vol-load-data-func-12" name="__codelineno-online-stoch-vol-load-data-func-12" href="#__codelineno-online-stoch-vol-load-data-func-12"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">stock</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-load-data-func-13"><a id="__codelineno-online-stoch-vol-load-data-func-13" name="__codelineno-online-stoch-vol-load-data-func-13" href="#__codelineno-online-stoch-vol-load-data-func-13"></a>
</span><span id="__span-online-stoch-vol-load-data-func-14"><a id="__codelineno-online-stoch-vol-load-data-func-14" name="__codelineno-online-stoch-vol-load-data-func-14" href="#__codelineno-online-stoch-vol-load-data-func-14"></a>    <span class="c1"># Calculate log returns</span>
</span><span id="__span-online-stoch-vol-load-data-func-15"><a id="__codelineno-online-stoch-vol-load-data-func-15" name="__codelineno-online-stoch-vol-load-data-func-15" href="#__codelineno-online-stoch-vol-load-data-func-15"></a>    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;log_return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="__span-online-stoch-vol-load-data-func-16"><a id="__codelineno-online-stoch-vol-load-data-func-16" name="__codelineno-online-stoch-vol-load-data-func-16" href="#__codelineno-online-stoch-vol-load-data-func-16"></a>
</span><span id="__span-online-stoch-vol-load-data-func-17"><a id="__codelineno-online-stoch-vol-load-data-func-17" name="__codelineno-online-stoch-vol-load-data-func-17" href="#__codelineno-online-stoch-vol-load-data-func-17"></a>    <span class="c1"># Remove first row (NaN log return)</span>
</span><span id="__span-online-stoch-vol-load-data-func-18"><a id="__codelineno-online-stoch-vol-load-data-func-18" name="__codelineno-online-stoch-vol-load-data-func-18" href="#__codelineno-online-stoch-vol-load-data-func-18"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="__span-online-stoch-vol-load-data-func-19"><a id="__codelineno-online-stoch-vol-load-data-func-19" name="__codelineno-online-stoch-vol-load-data-func-19" href="#__codelineno-online-stoch-vol-load-data-func-19"></a>
</span><span id="__span-online-stoch-vol-load-data-func-20"><a id="__codelineno-online-stoch-vol-load-data-func-20" name="__codelineno-online-stoch-vol-load-data-func-20" href="#__codelineno-online-stoch-vol-load-data-func-20"></a>    <span class="c1"># Convert dates to days since first observation</span>
</span><span id="__span-online-stoch-vol-load-data-func-21"><a id="__codelineno-online-stoch-vol-load-data-func-21" name="__codelineno-online-stoch-vol-load-data-func-21" href="#__codelineno-online-stoch-vol-load-data-func-21"></a>    <span class="n">origin_date</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-online-stoch-vol-load-data-func-22"><a id="__codelineno-online-stoch-vol-load-data-func-22" name="__codelineno-online-stoch-vol-load-data-func-22" href="#__codelineno-online-stoch-vol-load-data-func-22"></a>    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;days_since_origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">origin_date</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
</span><span id="__span-online-stoch-vol-load-data-func-23"><a id="__codelineno-online-stoch-vol-load-data-func-23" name="__codelineno-online-stoch-vol-load-data-func-23" href="#__codelineno-online-stoch-vol-load-data-func-23"></a>
</span><span id="__span-online-stoch-vol-load-data-func-24"><a id="__codelineno-online-stoch-vol-load-data-func-24" name="__codelineno-online-stoch-vol-load-data-func-24" href="#__codelineno-online-stoch-vol-load-data-func-24"></a>    <span class="k">return</span> <span class="n">data</span>
</span></code></pre></div>
</details>
<div id="online-stoch-vol-load-data" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-load-data-1"><a id="__codelineno-online-stoch-vol-load-data-1" name="__codelineno-online-stoch-vol-load-data-1" href="#__codelineno-online-stoch-vol-load-data-1"></a><span class="n">data</span> <span class="o">=</span> <span class="n">download_stock_data</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="s2">&quot;MKS.L&quot;</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-load-data-2"><a id="__codelineno-online-stoch-vol-load-data-2" name="__codelineno-online-stoch-vol-load-data-2" href="#__codelineno-online-stoch-vol-load-data-2"></a>
</span><span id="__span-online-stoch-vol-load-data-3"><a id="__codelineno-online-stoch-vol-load-data-3" name="__codelineno-online-stoch-vol-load-data-3" href="#__codelineno-online-stoch-vol-load-data-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</span></code></pre></div>
<h2 id="model-inputs-for-cuthbert">Model inputs for <code>cuthbert</code></h2>
<p>We'll now extract the data we require for inference, this will be the current and
previous timestamps (we'll just use daily frequency data here) as well as the log
return of the stock price.</p>
<p>The data will be stored as <code>jax</code> arrays in a convenient <code>NamedTuple</code>.</p>
<div id="online-stoch-vol-model-inputs" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-model-inputs-1"><a id="__codelineno-online-stoch-vol-model-inputs-1" name="__codelineno-online-stoch-vol-model-inputs-1" href="#__codelineno-online-stoch-vol-model-inputs-1"></a><span class="c1"># Create model inputs</span>
</span><span id="__span-online-stoch-vol-model-inputs-2"><a id="__codelineno-online-stoch-vol-model-inputs-2" name="__codelineno-online-stoch-vol-model-inputs-2" href="#__codelineno-online-stoch-vol-model-inputs-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ObservationData</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
</span><span id="__span-online-stoch-vol-model-inputs-3"><a id="__codelineno-online-stoch-vol-model-inputs-3" name="__codelineno-online-stoch-vol-model-inputs-3" href="#__codelineno-online-stoch-vol-model-inputs-3"></a>    <span class="n">time</span><span class="p">:</span> <span class="n">Array</span>  <span class="c1"># Current observation time (days since origin)</span>
</span><span id="__span-online-stoch-vol-model-inputs-4"><a id="__codelineno-online-stoch-vol-model-inputs-4" name="__codelineno-online-stoch-vol-model-inputs-4" href="#__codelineno-online-stoch-vol-model-inputs-4"></a>    <span class="n">time_prev</span><span class="p">:</span> <span class="n">Array</span>  <span class="c1"># Previous observation time (days since origin)</span>
</span><span id="__span-online-stoch-vol-model-inputs-5"><a id="__codelineno-online-stoch-vol-model-inputs-5" name="__codelineno-online-stoch-vol-model-inputs-5" href="#__codelineno-online-stoch-vol-model-inputs-5"></a>    <span class="n">log_return</span><span class="p">:</span> <span class="n">Array</span>  <span class="c1"># Log return Y_t = log(price_t / price_{t-1})</span>
</span><span id="__span-online-stoch-vol-model-inputs-6"><a id="__codelineno-online-stoch-vol-model-inputs-6" name="__codelineno-online-stoch-vol-model-inputs-6" href="#__codelineno-online-stoch-vol-model-inputs-6"></a>
</span><span id="__span-online-stoch-vol-model-inputs-7"><a id="__codelineno-online-stoch-vol-model-inputs-7" name="__codelineno-online-stoch-vol-model-inputs-7" href="#__codelineno-online-stoch-vol-model-inputs-7"></a>
</span><span id="__span-online-stoch-vol-model-inputs-8"><a id="__codelineno-online-stoch-vol-model-inputs-8" name="__codelineno-online-stoch-vol-model-inputs-8" href="#__codelineno-online-stoch-vol-model-inputs-8"></a><span class="n">times</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;days_since_origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-inputs-9"><a id="__codelineno-online-stoch-vol-model-inputs-9" name="__codelineno-online-stoch-vol-model-inputs-9" href="#__codelineno-online-stoch-vol-model-inputs-9"></a><span class="n">log_returns</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;log_return&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-inputs-10"><a id="__codelineno-online-stoch-vol-model-inputs-10" name="__codelineno-online-stoch-vol-model-inputs-10" href="#__codelineno-online-stoch-vol-model-inputs-10"></a>
</span><span id="__span-online-stoch-vol-model-inputs-11"><a id="__codelineno-online-stoch-vol-model-inputs-11" name="__codelineno-online-stoch-vol-model-inputs-11" href="#__codelineno-online-stoch-vol-model-inputs-11"></a><span class="c1"># Add dummy values to the start of the data</span>
</span><span id="__span-online-stoch-vol-model-inputs-12"><a id="__codelineno-online-stoch-vol-model-inputs-12" name="__codelineno-online-stoch-vol-model-inputs-12" href="#__codelineno-online-stoch-vol-model-inputs-12"></a><span class="c1"># (no observation for init_prepare)</span>
</span><span id="__span-online-stoch-vol-model-inputs-13"><a id="__codelineno-online-stoch-vol-model-inputs-13" name="__codelineno-online-stoch-vol-model-inputs-13" href="#__codelineno-online-stoch-vol-model-inputs-13"></a><span class="n">times</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">times</span><span class="p">])</span>
</span><span id="__span-online-stoch-vol-model-inputs-14"><a id="__codelineno-online-stoch-vol-model-inputs-14" name="__codelineno-online-stoch-vol-model-inputs-14" href="#__codelineno-online-stoch-vol-model-inputs-14"></a><span class="n">log_returns</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span> <span class="n">log_returns</span><span class="p">])</span>
</span><span id="__span-online-stoch-vol-model-inputs-15"><a id="__codelineno-online-stoch-vol-model-inputs-15" name="__codelineno-online-stoch-vol-model-inputs-15" href="#__codelineno-online-stoch-vol-model-inputs-15"></a>
</span><span id="__span-online-stoch-vol-model-inputs-16"><a id="__codelineno-online-stoch-vol-model-inputs-16" name="__codelineno-online-stoch-vol-model-inputs-16" href="#__codelineno-online-stoch-vol-model-inputs-16"></a><span class="n">times_prev</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">times</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="__span-online-stoch-vol-model-inputs-17"><a id="__codelineno-online-stoch-vol-model-inputs-17" name="__codelineno-online-stoch-vol-model-inputs-17" href="#__codelineno-online-stoch-vol-model-inputs-17"></a>
</span><span id="__span-online-stoch-vol-model-inputs-18"><a id="__codelineno-online-stoch-vol-model-inputs-18" name="__codelineno-online-stoch-vol-model-inputs-18" href="#__codelineno-online-stoch-vol-model-inputs-18"></a><span class="n">obs_data</span> <span class="o">=</span> <span class="n">ObservationData</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-model-inputs-19"><a id="__codelineno-online-stoch-vol-model-inputs-19" name="__codelineno-online-stoch-vol-model-inputs-19" href="#__codelineno-online-stoch-vol-model-inputs-19"></a>    <span class="n">time</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-model-inputs-20"><a id="__codelineno-online-stoch-vol-model-inputs-20" name="__codelineno-online-stoch-vol-model-inputs-20" href="#__codelineno-online-stoch-vol-model-inputs-20"></a>    <span class="n">time_prev</span><span class="o">=</span><span class="n">times_prev</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-model-inputs-21"><a id="__codelineno-online-stoch-vol-model-inputs-21" name="__codelineno-online-stoch-vol-model-inputs-21" href="#__codelineno-online-stoch-vol-model-inputs-21"></a>    <span class="n">log_return</span><span class="o">=</span><span class="n">log_returns</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-model-inputs-22"><a id="__codelineno-online-stoch-vol-model-inputs-22" name="__codelineno-online-stoch-vol-model-inputs-22" href="#__codelineno-online-stoch-vol-model-inputs-22"></a><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-inputs-23"><a id="__codelineno-online-stoch-vol-model-inputs-23" name="__codelineno-online-stoch-vol-model-inputs-23" href="#__codelineno-online-stoch-vol-model-inputs-23"></a>
</span><span id="__span-online-stoch-vol-model-inputs-24"><a id="__codelineno-online-stoch-vol-model-inputs-24" name="__codelineno-online-stoch-vol-model-inputs-24" href="#__codelineno-online-stoch-vol-model-inputs-24"></a><span class="n">previous_data</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">obs_data</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-inputs-25"><a id="__codelineno-online-stoch-vol-model-inputs-25" name="__codelineno-online-stoch-vol-model-inputs-25" href="#__codelineno-online-stoch-vol-model-inputs-25"></a><span class="n">new_data</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">obs_data</span><span class="p">)</span>
</span></code></pre></div>
<p>We've also (synthetically) split the data into previous and new data to mimic an
online inference setting.</p>
<h2 id="stochastic-volatility-model">Stochastic volatility model</h2>
<p>The model we'll use is a simple stochastic volatility model from section 2.4.3
in <a href="https://doi.org/10.1007/978-3-030-47845-2">Chopin and Papaspiliopoulos (2023)</a>
but adapt the dynamics to be defined in continuous-time so that we can handle
irregular observation times.</p>
<div class="arithmatex">\[
\begin{aligned}
    p(x_0) &amp; = \mathrm{N}(x_0 \mid \mu, \sigma^2), \\
    dx_t &amp;= - \theta (x_t - \mu) dt + \sigma dW_t, \\
    p(y_t | x_t) &amp; = \mathrm{N}(y_t\mid 0, \exp(x_t)),
\end{aligned}
\]</div>
<p>The continuous-time dynamics represent an <a href="https://en.wikipedia.org/wiki/Ornstein%E2%80%93Uhlenbeck_process">Ornstein-Uhlenbeck process</a>, which is a mean-reverting stochastic process.
It can be solved exactly giving</p>
<div class="arithmatex">\[
\begin{aligned}
    p(x_{t +\delta_t} \mid x_t) &amp;= \mathrm{N}(x_t \mid \mu(\delta_t), \sigma(\delta_t)^2),\\
    \mu(\delta_t) &amp;= \mu + (x_t - \mu) e^{-\theta \delta_t}, \\
    \sigma(\delta_t)^2 &amp;= \sigma^2 \frac{1 - e^{-2 \theta \delta_t}}{2 \theta}. \\
\end{aligned}
\]</div>
<p>We'll set the hyperparameters of the model without thinking too much, in practice you'd
probably want to learn these from the data too!</p>
<div id="online-stoch-vol-model-params" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-model-params-1"><a id="__codelineno-online-stoch-vol-model-params-1" name="__codelineno-online-stoch-vol-model-params-1" href="#__codelineno-online-stoch-vol-model-params-1"></a><span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Mean log-volatility (to revert to)</span>
</span><span id="__span-online-stoch-vol-model-params-2"><a id="__codelineno-online-stoch-vol-model-params-2" name="__codelineno-online-stoch-vol-model-params-2" href="#__codelineno-online-stoch-vol-model-params-2"></a><span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)</span>  <span class="c1"># Persistence (close to 1 for volatility clustering)</span>
</span><span id="__span-online-stoch-vol-model-params-3"><a id="__codelineno-online-stoch-vol-model-params-3" name="__codelineno-online-stoch-vol-model-params-3" href="#__codelineno-online-stoch-vol-model-params-3"></a><span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.3</span>  <span class="c1"># Volatility of volatility</span>
</span><span id="__span-online-stoch-vol-model-params-4"><a id="__codelineno-online-stoch-vol-model-params-4" name="__codelineno-online-stoch-vol-model-params-4" href="#__codelineno-online-stoch-vol-model-params-4"></a><span class="n">init_mean</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial mean</span>
</span><span id="__span-online-stoch-vol-model-params-5"><a id="__codelineno-online-stoch-vol-model-params-5" name="__codelineno-online-stoch-vol-model-params-5" href="#__codelineno-online-stoch-vol-model-params-5"></a><span class="n">init_std</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Initial stds</span>
</span></code></pre></div>
<p>Then we'll convert our mathematical model into one that <code>cuthbert.smc.particle_filter</code>
can understand.</p>
<div id="online-stoch-vol-model-func" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-model-func-1"><a id="__codelineno-online-stoch-vol-model-func-1" name="__codelineno-online-stoch-vol-model-func-1" href="#__codelineno-online-stoch-vol-model-func-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_sample</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">model_inputs</span><span class="p">:</span> <span class="n">ObservationData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="__span-online-stoch-vol-model-func-2"><a id="__codelineno-online-stoch-vol-model-func-2" name="__codelineno-online-stoch-vol-model-func-2" href="#__codelineno-online-stoch-vol-model-func-2"></a>    <span class="k">return</span> <span class="n">init_mean</span> <span class="o">+</span> <span class="n">init_std</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">())</span>
</span><span id="__span-online-stoch-vol-model-func-3"><a id="__codelineno-online-stoch-vol-model-func-3" name="__codelineno-online-stoch-vol-model-func-3" href="#__codelineno-online-stoch-vol-model-func-3"></a>
</span><span id="__span-online-stoch-vol-model-func-4"><a id="__codelineno-online-stoch-vol-model-func-4" name="__codelineno-online-stoch-vol-model-func-4" href="#__codelineno-online-stoch-vol-model-func-4"></a>
</span><span id="__span-online-stoch-vol-model-func-5"><a id="__codelineno-online-stoch-vol-model-func-5" name="__codelineno-online-stoch-vol-model-func-5" href="#__codelineno-online-stoch-vol-model-func-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">propagate_sample</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">model_inputs</span><span class="p">:</span> <span class="n">ObservationData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="__span-online-stoch-vol-model-func-6"><a id="__codelineno-online-stoch-vol-model-func-6" name="__codelineno-online-stoch-vol-model-func-6" href="#__codelineno-online-stoch-vol-model-func-6"></a>    <span class="n">dt</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">time_prev</span>
</span><span id="__span-online-stoch-vol-model-func-7"><a id="__codelineno-online-stoch-vol-model-func-7" name="__codelineno-online-stoch-vol-model-func-7" href="#__codelineno-online-stoch-vol-model-func-7"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="p">(</span><span class="n">state</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-func-8"><a id="__codelineno-online-stoch-vol-model-func-8" name="__codelineno-online-stoch-vol-model-func-8" href="#__codelineno-online-stoch-vol-model-func-8"></a>    <span class="n">var</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-func-9"><a id="__codelineno-online-stoch-vol-model-func-9" name="__codelineno-online-stoch-vol-model-func-9" href="#__codelineno-online-stoch-vol-model-func-9"></a>    <span class="n">std</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-func-10"><a id="__codelineno-online-stoch-vol-model-func-10" name="__codelineno-online-stoch-vol-model-func-10" href="#__codelineno-online-stoch-vol-model-func-10"></a>    <span class="k">return</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">std</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">())</span>
</span><span id="__span-online-stoch-vol-model-func-11"><a id="__codelineno-online-stoch-vol-model-func-11" name="__codelineno-online-stoch-vol-model-func-11" href="#__codelineno-online-stoch-vol-model-func-11"></a>
</span><span id="__span-online-stoch-vol-model-func-12"><a id="__codelineno-online-stoch-vol-model-func-12" name="__codelineno-online-stoch-vol-model-func-12" href="#__codelineno-online-stoch-vol-model-func-12"></a>
</span><span id="__span-online-stoch-vol-model-func-13"><a id="__codelineno-online-stoch-vol-model-func-13" name="__codelineno-online-stoch-vol-model-func-13" href="#__codelineno-online-stoch-vol-model-func-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">log_potential</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-model-func-14"><a id="__codelineno-online-stoch-vol-model-func-14" name="__codelineno-online-stoch-vol-model-func-14" href="#__codelineno-online-stoch-vol-model-func-14"></a>    <span class="n">state_prev</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">model_inputs</span><span class="p">:</span> <span class="n">ObservationData</span>
</span><span id="__span-online-stoch-vol-model-func-15"><a id="__codelineno-online-stoch-vol-model-func-15" name="__codelineno-online-stoch-vol-model-func-15" href="#__codelineno-online-stoch-vol-model-func-15"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
</span><span id="__span-online-stoch-vol-model-func-16"><a id="__codelineno-online-stoch-vol-model-func-16" name="__codelineno-online-stoch-vol-model-func-16" href="#__codelineno-online-stoch-vol-model-func-16"></a>    <span class="c1"># Check if observation is missing (NaN)</span>
</span><span id="__span-online-stoch-vol-model-func-17"><a id="__codelineno-online-stoch-vol-model-func-17" name="__codelineno-online-stoch-vol-model-func-17" href="#__codelineno-online-stoch-vol-model-func-17"></a>    <span class="n">is_missing</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">model_inputs</span><span class="o">.</span><span class="n">log_return</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-func-18"><a id="__codelineno-online-stoch-vol-model-func-18" name="__codelineno-online-stoch-vol-model-func-18" href="#__codelineno-online-stoch-vol-model-func-18"></a>
</span><span id="__span-online-stoch-vol-model-func-19"><a id="__codelineno-online-stoch-vol-model-func-19" name="__codelineno-online-stoch-vol-model-func-19" href="#__codelineno-online-stoch-vol-model-func-19"></a>    <span class="c1"># Log likelihood: log p(Y_t | X_t) = log N(Y_t; 0, exp(X_t))</span>
</span><span id="__span-online-stoch-vol-model-func-20"><a id="__codelineno-online-stoch-vol-model-func-20" name="__codelineno-online-stoch-vol-model-func-20" href="#__codelineno-online-stoch-vol-model-func-20"></a>    <span class="n">log_vol</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="__span-online-stoch-vol-model-func-21"><a id="__codelineno-online-stoch-vol-model-func-21" name="__codelineno-online-stoch-vol-model-func-21" href="#__codelineno-online-stoch-vol-model-func-21"></a>    <span class="n">vol</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">log_vol</span><span class="p">)</span>  <span class="c1"># exp(X_t/2) = sqrt(exp(X_t))</span>
</span><span id="__span-online-stoch-vol-model-func-22"><a id="__codelineno-online-stoch-vol-model-func-22" name="__codelineno-online-stoch-vol-model-func-22" href="#__codelineno-online-stoch-vol-model-func-22"></a>    <span class="n">log_pot</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">model_inputs</span><span class="o">.</span><span class="n">log_return</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-model-func-23"><a id="__codelineno-online-stoch-vol-model-func-23" name="__codelineno-online-stoch-vol-model-func-23" href="#__codelineno-online-stoch-vol-model-func-23"></a>
</span><span id="__span-online-stoch-vol-model-func-24"><a id="__codelineno-online-stoch-vol-model-func-24" name="__codelineno-online-stoch-vol-model-func-24" href="#__codelineno-online-stoch-vol-model-func-24"></a>    <span class="c1"># Missing observation = uniform potential =&gt; filter just propagates</span>
</span><span id="__span-online-stoch-vol-model-func-25"><a id="__codelineno-online-stoch-vol-model-func-25" name="__codelineno-online-stoch-vol-model-func-25" href="#__codelineno-online-stoch-vol-model-func-25"></a>    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_missing</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">log_pot</span><span class="p">)</span>
</span></code></pre></div>
<p>It's important to note here how we've handled <code>nan</code> values in the log-return data.
When we encounter a <code>nan</code> value, we set the log-potential to 0 which means tell the
particle filter there is no information in the likelihood for that time step. This
allows us to do prediction as filtering with missing data.</p>
<h2 id="setup-the-particle-filter">Setup the particle filter</h2>
<p>Now we'll get <code>cuthbert</code> involved! We'll choose a number of particles and a threshold
on how often to resample before constructing the filter object.</p>
<div id="online-stoch-vol-particle-filter-setup" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-particle-filter-setup-1"><a id="__codelineno-online-stoch-vol-particle-filter-setup-1" name="__codelineno-online-stoch-vol-particle-filter-setup-1" href="#__codelineno-online-stoch-vol-particle-filter-setup-1"></a><span class="n">n_particles</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-2"><a id="__codelineno-online-stoch-vol-particle-filter-setup-2" name="__codelineno-online-stoch-vol-particle-filter-setup-2" href="#__codelineno-online-stoch-vol-particle-filter-setup-2"></a><span class="n">resampling</span> <span class="o">=</span> <span class="n">adaptive</span><span class="o">.</span><span class="n">ess_decorator</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-3"><a id="__codelineno-online-stoch-vol-particle-filter-setup-3" name="__codelineno-online-stoch-vol-particle-filter-setup-3" href="#__codelineno-online-stoch-vol-particle-filter-setup-3"></a>    <span class="n">systematic</span><span class="o">.</span><span class="n">resampling</span><span class="p">,</span> <span class="mf">0.5</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-4"><a id="__codelineno-online-stoch-vol-particle-filter-setup-4" name="__codelineno-online-stoch-vol-particle-filter-setup-4" href="#__codelineno-online-stoch-vol-particle-filter-setup-4"></a><span class="p">)</span>  <span class="c1"># Resample when ESS drops below 50%</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-5"><a id="__codelineno-online-stoch-vol-particle-filter-setup-5" name="__codelineno-online-stoch-vol-particle-filter-setup-5" href="#__codelineno-online-stoch-vol-particle-filter-setup-5"></a>
</span><span id="__span-online-stoch-vol-particle-filter-setup-6"><a id="__codelineno-online-stoch-vol-particle-filter-setup-6" name="__codelineno-online-stoch-vol-particle-filter-setup-6" href="#__codelineno-online-stoch-vol-particle-filter-setup-6"></a><span class="n">pf</span> <span class="o">=</span> <span class="n">particle_filter</span><span class="o">.</span><span class="n">build_filter</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-7"><a id="__codelineno-online-stoch-vol-particle-filter-setup-7" name="__codelineno-online-stoch-vol-particle-filter-setup-7" href="#__codelineno-online-stoch-vol-particle-filter-setup-7"></a>    <span class="n">init_sample</span><span class="o">=</span><span class="n">init_sample</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-8"><a id="__codelineno-online-stoch-vol-particle-filter-setup-8" name="__codelineno-online-stoch-vol-particle-filter-setup-8" href="#__codelineno-online-stoch-vol-particle-filter-setup-8"></a>    <span class="n">propagate_sample</span><span class="o">=</span><span class="n">propagate_sample</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-9"><a id="__codelineno-online-stoch-vol-particle-filter-setup-9" name="__codelineno-online-stoch-vol-particle-filter-setup-9" href="#__codelineno-online-stoch-vol-particle-filter-setup-9"></a>    <span class="n">log_potential</span><span class="o">=</span><span class="n">log_potential</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-10"><a id="__codelineno-online-stoch-vol-particle-filter-setup-10" name="__codelineno-online-stoch-vol-particle-filter-setup-10" href="#__codelineno-online-stoch-vol-particle-filter-setup-10"></a>    <span class="n">n_filter_particles</span><span class="o">=</span><span class="n">n_particles</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-11"><a id="__codelineno-online-stoch-vol-particle-filter-setup-11" name="__codelineno-online-stoch-vol-particle-filter-setup-11" href="#__codelineno-online-stoch-vol-particle-filter-setup-11"></a>    <span class="n">resampling_fn</span><span class="o">=</span><span class="n">systematic</span><span class="o">.</span><span class="n">resampling</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-setup-12"><a id="__codelineno-online-stoch-vol-particle-filter-setup-12" name="__codelineno-online-stoch-vol-particle-filter-setup-12" href="#__codelineno-online-stoch-vol-particle-filter-setup-12"></a><span class="p">)</span>
</span></code></pre></div>
<p>We'll then use the <code>cuthbert.filter</code> offline filtering function to run on the previous
data.</p>
<div id="online-stoch-vol-particle-filter-run-previous" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-particle-filter-run-previous-1"><a id="__codelineno-online-stoch-vol-particle-filter-run-previous-1" name="__codelineno-online-stoch-vol-particle-filter-run-previous-1" href="#__codelineno-online-stoch-vol-particle-filter-run-previous-1"></a><span class="n">key</span><span class="p">,</span> <span class="n">previous_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="__span-online-stoch-vol-particle-filter-run-previous-2"><a id="__codelineno-online-stoch-vol-particle-filter-run-previous-2" name="__codelineno-online-stoch-vol-particle-filter-run-previous-2" href="#__codelineno-online-stoch-vol-particle-filter-run-previous-2"></a><span class="n">previous_states</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="n">previous_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-run-previous-3"><a id="__codelineno-online-stoch-vol-particle-filter-run-previous-3" name="__codelineno-online-stoch-vol-particle-filter-run-previous-3" href="#__codelineno-online-stoch-vol-particle-filter-run-previous-3"></a><span class="n">filter_state</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">previous_states</span><span class="p">)</span>
</span></code></pre></div>
<p>The last line simply extracts the final temporal state. Now we are mimicking an online
inference setting where we have a previous filter state and we want to predict the
next time point.</p>
<h2 id="online-prediction">Online prediction</h2>
<p>We'll now propagate the approximation forward to the next time point and
probabilistically predict the log-volatility and log-return.</p>
<div id="online-stoch-vol-particle-filter-predict" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-particle-filter-predict-1"><a id="__codelineno-online-stoch-vol-particle-filter-predict-1" name="__codelineno-online-stoch-vol-particle-filter-predict-1" href="#__codelineno-online-stoch-vol-particle-filter-predict-1"></a><span class="n">predict_model_inputs</span> <span class="o">=</span> <span class="n">ObservationData</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-2"><a id="__codelineno-online-stoch-vol-particle-filter-predict-2" name="__codelineno-online-stoch-vol-particle-filter-predict-2" href="#__codelineno-online-stoch-vol-particle-filter-predict-2"></a>    <span class="n">time</span><span class="o">=</span><span class="n">new_data</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-3"><a id="__codelineno-online-stoch-vol-particle-filter-predict-3" name="__codelineno-online-stoch-vol-particle-filter-predict-3" href="#__codelineno-online-stoch-vol-particle-filter-predict-3"></a>    <span class="n">time_prev</span><span class="o">=</span><span class="n">new_data</span><span class="o">.</span><span class="n">time_prev</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-4"><a id="__codelineno-online-stoch-vol-particle-filter-predict-4" name="__codelineno-online-stoch-vol-particle-filter-predict-4" href="#__codelineno-online-stoch-vol-particle-filter-predict-4"></a>    <span class="n">log_return</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>  <span class="c1"># nan indicates missing observation, so filter-&gt;predict</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-5"><a id="__codelineno-online-stoch-vol-particle-filter-predict-5" name="__codelineno-online-stoch-vol-particle-filter-predict-5" href="#__codelineno-online-stoch-vol-particle-filter-predict-5"></a><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-6"><a id="__codelineno-online-stoch-vol-particle-filter-predict-6" name="__codelineno-online-stoch-vol-particle-filter-predict-6" href="#__codelineno-online-stoch-vol-particle-filter-predict-6"></a><span class="n">key</span><span class="p">,</span> <span class="n">predict_key</span><span class="p">,</span> <span class="n">predict_ys_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-7"><a id="__codelineno-online-stoch-vol-particle-filter-predict-7" name="__codelineno-online-stoch-vol-particle-filter-predict-7" href="#__codelineno-online-stoch-vol-particle-filter-predict-7"></a><span class="n">predict_state</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">filter_combine</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-8"><a id="__codelineno-online-stoch-vol-particle-filter-predict-8" name="__codelineno-online-stoch-vol-particle-filter-predict-8" href="#__codelineno-online-stoch-vol-particle-filter-predict-8"></a>    <span class="n">filter_state</span><span class="p">,</span> <span class="n">pf</span><span class="o">.</span><span class="n">filter_prepare</span><span class="p">(</span><span class="n">predict_model_inputs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">predict_key</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-9"><a id="__codelineno-online-stoch-vol-particle-filter-predict-9" name="__codelineno-online-stoch-vol-particle-filter-predict-9" href="#__codelineno-online-stoch-vol-particle-filter-predict-9"></a><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-10"><a id="__codelineno-online-stoch-vol-particle-filter-predict-10" name="__codelineno-online-stoch-vol-particle-filter-predict-10" href="#__codelineno-online-stoch-vol-particle-filter-predict-10"></a><span class="n">predict_weights</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-11"><a id="__codelineno-online-stoch-vol-particle-filter-predict-11" name="__codelineno-online-stoch-vol-particle-filter-predict-11" href="#__codelineno-online-stoch-vol-particle-filter-predict-11"></a>    <span class="n">predict_state</span><span class="o">.</span><span class="n">log_weights</span> <span class="o">-</span> <span class="n">nn</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">predict_state</span><span class="o">.</span><span class="n">log_weights</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-12"><a id="__codelineno-online-stoch-vol-particle-filter-predict-12" name="__codelineno-online-stoch-vol-particle-filter-predict-12" href="#__codelineno-online-stoch-vol-particle-filter-predict-12"></a><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-13"><a id="__codelineno-online-stoch-vol-particle-filter-predict-13" name="__codelineno-online-stoch-vol-particle-filter-predict-13" href="#__codelineno-online-stoch-vol-particle-filter-predict-13"></a><span class="n">predict_ys</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">predict_state</span><span class="o">.</span><span class="n">particles</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-14"><a id="__codelineno-online-stoch-vol-particle-filter-predict-14" name="__codelineno-online-stoch-vol-particle-filter-predict-14" href="#__codelineno-online-stoch-vol-particle-filter-predict-14"></a>    <span class="n">predict_ys_key</span><span class="p">,</span> <span class="p">(</span><span class="n">n_particles</span><span class="p">,)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-15"><a id="__codelineno-online-stoch-vol-particle-filter-predict-15" name="__codelineno-online-stoch-vol-particle-filter-predict-15" href="#__codelineno-online-stoch-vol-particle-filter-predict-15"></a><span class="p">)</span>
</span></code></pre></div>
<p>Now we'll plot the distributions over our predicted values.</p>
<details class="quote">
<summary>Code to plot the predicted distributions.</summary>
<div id="online-stoch-vol-particle-filter-predict-plot" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-particle-filter-predict-plot-1"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-1" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-1" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-1"></a><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-2"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-2" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-2" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-2"></a><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-3"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-3" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-3" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-3"></a>    <span class="n">predict_state</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-4"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-4" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-4" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-4"></a>    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-5"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-5" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-5" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-5"></a>    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-6"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-6" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-6" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-6"></a>    <span class="n">weights</span><span class="o">=</span><span class="n">predict_weights</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-7"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-7" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-7" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-7"></a>    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted latent log-volatility&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-8"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-8" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-8" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-8"></a>    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#b6d7a8&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-9"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-9" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-9" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-9"></a>    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-10"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-10" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-10" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-10"></a><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-11"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-11" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-11" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-11"></a><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Latent log-volatility&quot;</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-12"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-12" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-12" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-12"></a><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-13"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-13" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-13" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-13"></a><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-14"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-14" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-14" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-14"></a>    <span class="n">predict_ys</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-15"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-15" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-15" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-15"></a>    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-16"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-16" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-16" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-16"></a>    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-17"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-17" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-17" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-17"></a>    <span class="n">weights</span><span class="o">=</span><span class="n">predict_weights</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-18"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-18" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-18" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-18"></a>    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted log-return&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-19"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-19" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-19" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-19"></a>    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#eeeeee&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-20"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-20" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-20" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-20"></a>    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-21"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-21" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-21" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-21"></a><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-22"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-22" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-22" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-22"></a><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">new_data</span><span class="o">.</span><span class="n">log_return</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True log-return (unseen)&quot;</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-23"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-23" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-23" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-23"></a><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Log-return&quot;</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-24"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-24" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-24" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-24"></a><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-25"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-25" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-25" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-25"></a><span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-online-stoch-vol-particle-filter-predict-plot-26"><a id="__codelineno-online-stoch-vol-particle-filter-predict-plot-26" name="__codelineno-online-stoch-vol-particle-filter-predict-plot-26" href="#__codelineno-online-stoch-vol-particle-filter-predict-plot-26"></a><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;docs/assets/online_stoch_vol_predict.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span></code></pre></div>
</details>
<p><img alt="Predicted distributions" src="../../assets/online_stoch_vol_predict.png" /></p>
<p>We've also highlighted for reference the true log-return (which is unseen) in red, which
the particle filter has not seen (yet).</p>
<h2 id="online-filtering">Online filtering</h2>
<p>Now we'll update the approximation with the new data.</p>
<p><div id="online-stoch-vol-particle-filter-filter" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-particle-filter-filter-1"><a id="__codelineno-online-stoch-vol-particle-filter-filter-1" name="__codelineno-online-stoch-vol-particle-filter-filter-1" href="#__codelineno-online-stoch-vol-particle-filter-filter-1"></a><span class="n">key</span><span class="p">,</span> <span class="n">filter_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-2"><a id="__codelineno-online-stoch-vol-particle-filter-filter-2" name="__codelineno-online-stoch-vol-particle-filter-filter-2" href="#__codelineno-online-stoch-vol-particle-filter-filter-2"></a><span class="n">new_filter_state</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">filter_combine</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-3"><a id="__codelineno-online-stoch-vol-particle-filter-filter-3" name="__codelineno-online-stoch-vol-particle-filter-filter-3" href="#__codelineno-online-stoch-vol-particle-filter-filter-3"></a>    <span class="n">filter_state</span><span class="p">,</span> <span class="n">pf</span><span class="o">.</span><span class="n">filter_prepare</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">filter_key</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-4"><a id="__codelineno-online-stoch-vol-particle-filter-filter-4" name="__codelineno-online-stoch-vol-particle-filter-filter-4" href="#__codelineno-online-stoch-vol-particle-filter-filter-4"></a><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-5"><a id="__codelineno-online-stoch-vol-particle-filter-filter-5" name="__codelineno-online-stoch-vol-particle-filter-filter-5" href="#__codelineno-online-stoch-vol-particle-filter-filter-5"></a><span class="n">new_filter_weights</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-6"><a id="__codelineno-online-stoch-vol-particle-filter-filter-6" name="__codelineno-online-stoch-vol-particle-filter-filter-6" href="#__codelineno-online-stoch-vol-particle-filter-filter-6"></a>    <span class="n">new_filter_state</span><span class="o">.</span><span class="n">log_weights</span> <span class="o">-</span> <span class="n">nn</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">new_filter_state</span><span class="o">.</span><span class="n">log_weights</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-7"><a id="__codelineno-online-stoch-vol-particle-filter-filter-7" name="__codelineno-online-stoch-vol-particle-filter-filter-7" href="#__codelineno-online-stoch-vol-particle-filter-filter-7"></a><span class="p">)</span>
</span></code></pre></div>
This time the filter sees the actual log-return rather than <code>jnp.nan</code>.</p>
<details class="quote">
<summary>Code to plot the filtered distribution.</summary>
<div id="online-stoch-vol-particle-filter-filter-plot" class="language-python highlight"><pre><span></span><code><span id="__span-online-stoch-vol-particle-filter-filter-plot-1"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-1" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-1" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-1"></a><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-2"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-2" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-2" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-2"></a><span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-3"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-3" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-3" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-3"></a>    <span class="n">new_filter_state</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-4"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-4" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-4" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-4"></a>    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-5"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-5" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-5" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-5"></a>    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-6"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-6" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-6" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-6"></a>    <span class="n">weights</span><span class="o">=</span><span class="n">new_filter_weights</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-7"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-7" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-7" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-7"></a>    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filtered latent log-volatility&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-8"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-8" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-8" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-8"></a>    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#b6d7a8&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-9"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-9" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-9" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-9"></a>    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-10"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-10" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-10" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-10"></a><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-11"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-11" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-11" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-11"></a><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Latent log-volatility&quot;</span><span class="p">)</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-12"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-12" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-12" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-12"></a><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-13"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-13" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-13" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-13"></a><span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-online-stoch-vol-particle-filter-filter-plot-14"><a id="__codelineno-online-stoch-vol-particle-filter-filter-plot-14" name="__codelineno-online-stoch-vol-particle-filter-filter-plot-14" href="#__codelineno-online-stoch-vol-particle-filter-filter-plot-14"></a><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;docs/assets/online_stoch_vol_filter.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</span></code></pre></div>
</details>
<p><img alt="Filtered distribution" src="../../assets/online_stoch_vol_filter.png" /></p>
<h2 id="key-takeaways">Key Takeaways</h2>
<ul>
<li>We can use <code>cuthbert</code> to perform online filtering and prediction in a state-space model.</li>
<li>We can handle irregular observation times by defining the model dynamics in continuous-time.</li>
<li>We can handle missing data in the observation model by setting the log-potential to 0.</li>
<li>Missing data also allows us to do prediction within the same filtering framework.</li>
</ul>
<h2 id="next-steps">Next Steps</h2>
<ul>
<li><strong>Smoothing</strong>: Use <a href="../../cuthbert_api/smoothing/"><code>cuthbert.smoother</code></a> to
  perform backward smoothing for more accurate historical state estimates.</li>
<li><strong>Parameter learning</strong>: Learn the hyperparameters from the data using gradient
  descent, expectation maximization (see the <a href="../parameter_estimation_em/">parameter estimation
  example</a>), or Bayesian sampling.</li>
<li><strong>More examples</strong>: Explore other <a href="../">examples</a> including <a href="../kalman_tracking/">Kalman
  filtering</a> and <a href="../temporal_parallelization_kalman/">temporal
  parallelization</a>.</li>
</ul>
<!--- entangled-tangle-block
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">setup</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">func</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">data</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">inputs</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">params</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">func</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">particle</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">setup</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">particle</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">run</span><span class="o">-</span><span class="n">previous</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">particle</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">predict</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">particle</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">predict</span><span class="o">-</span><span class="n">plot</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">particle</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="nb">filter</span><span class="o">&gt;&gt;</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="o">&lt;&lt;</span><span class="n">online</span><span class="o">-</span><span class="n">stoch</span><span class="o">-</span><span class="n">vol</span><span class="o">-</span><span class="n">particle</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">plot</span><span class="o">&gt;&gt;</span>
</span></code></pre></div>
-->












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "content.code.copy", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>